name: CI/CD Pipeline

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]


jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Шаг 1: Получение кода
      - name: Checkout repository
        uses: actions/checkout@v3

      # Шаг 2: Установка docker-compose
      - name: Install docker-compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

      # Шаг 4: Подтягивание образов
      - name: Pull images
        run: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/grpc_server:1.0
          docker pull ${{ secrets.DOCKER_USERNAME }}/cwbot:1.0

      # Шаг 5: Подготовка окружения
      - name: Create environment file
        run: |
          echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" > .env
          echo "COMMON_IMAGES_VERSION=1.0" >> .env
          echo "TARGET_IMAGES_VERSION=1.0" >> .env

      # Шаг 6: Запуск сервисов
      - name: Start services
        run: |
          docker-compose -f docker-compose.ci.yml up -d
          
          echo "Waiting for model loading (up to 10 minutes)..."
          timeout 10m docker logs -f cursedwordstgbot-grpc_server-1 | grep -q "Model loaded" || {
            echo "Model loading timeout"; exit 1
          }

      - name: Verify services
        run: |
          # Проверка, что контейнеры запущены
          docker ps --format "table {{.Names}}\t{{.Status}}"
          
          # Простая проверка порта gRPC
          echo "Checking gRPC port..."
          timeout 60 sh -c 'until nc -z $DOCKER_HOST 50051; do sleep 5; done' || {
            echo "gRPC port not available"
            exit 1
          }

      - name: Check bot container
        run: |
          container_id=$(docker ps -q -f "name=cwbot")
          if [ -z "$container_id" ]; then
            echo "Bot container not running!"
            exit 1
          fi
          echo "Bot container ID: $container_id"

      - name: Display bot logs
        run: docker logs $(docker ps -q -f "name=cwbot") --tail=50